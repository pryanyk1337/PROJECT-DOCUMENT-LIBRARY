# SELF_CHECK_PROTOCOLS.md

## НАЗНАЧЕНИЕ

Определяет алгоритмы и чек-листы самопроверки для AI-агентов. Три уровня проверки: базовый, расширенный, экспертный. Применяется агентом ПЕРЕД выдачей результата.

---

## РАЗДЕЛ 1: АРХИТЕКТУРА САМОПРОВЕРКИ

### 1.1 Место самопроверки в процессе агента

```
[ВХОД] → [ИНТЕРВЬЮ] → [ОСНОВНАЯ РАБОТА] → [САМОПРОВЕРКА] → [ВЫХОД]
                                               ↓
                                        [Если FAIL]
                                               ↓
                                        [КОРРЕКЦИЯ] → [САМОПРОВЕРКА]
                                               ↓
                                        [Макс. 3 итерации]
```

### 1.2 Триггеры запуска самопроверки

| Триггер | Уровень проверки |
|---------|------------------|
| Завершение основной работы | Базовый |
| Сложная задача (Режим 2-3) | Расширенный |
| Критичный контент (код, юридика, финансы) | Экспертный |
| Запрос пользователя "проверь тщательно" | Экспертный |

---

## РАЗДЕЛ 2: УРОВНИ САМОПРОВЕРКИ

### 2.1 Базовый уровень (BASIC)

**Время:** 30 секунд
**Применение:** Все задачи

```
## БАЗОВАЯ САМОПРОВЕРКА

Формат:
[ ] Выходной формат соответствует спецификации
[ ] Структура (заголовки, списки) корректна
[ ] Нет обрезанных предложений/таблиц

Полнота:
[ ] Все пункты задачи покрыты
[ ] Нет пропущенных секций
[ ] Артефакт завершён (не "продолжение следует")

Соответствие:
[ ] Результат отвечает на исходный запрос
[ ] Нет отклонений от задачи
[ ] Тон соответствует контексту

Минимум для PASS: 8/9 пунктов ✓
```

### 2.2 Расширенный уровень (EXTENDED)

**Время:** 2 минуты
**Применение:** Режим 2-3, многоэтапные задачи

```
## РАСШИРЕННАЯ САМОПРОВЕРКА

[Включает все пункты БАЗОВОЙ]

Логика:
[ ] Нет логических противоречий
[ ] Выводы следуют из данных
[ ] Причинно-следственные связи корректны

Качество:
[ ] Нет повторов информации
[ ] Нет избыточных пояснений
[ ] Каждый элемент несёт ценность

Метрики:
[ ] Token Efficiency ≥ 70%
[ ] Completion Rate = 100%
[ ] Все критерии успеха выполнены

Профильные проверки:
[К] Минимум 3-5 вариантов сгенерировано
[Б] Структура декомпозирована на 2+ уровня
[Т] Все утверждения верифицируемы

Минимум для PASS: 12/15 пунктов ✓
```

### 2.3 Экспертный уровень (EXPERT)

**Время:** 5 минут
**Применение:** Критичный контент, код, юридика

```
## ЭКСПЕРТНАЯ САМОПРОВЕРКА

[Включает все пункты РАСШИРЕННОЙ]

Безопасность:
[ ] Нет потенциально вредных советов
[ ] Нет нарушений этических норм
[ ] Указаны ограничения применимости

Источники (для Т-профиля):
[ ] Все факты имеют источники
[ ] Источники актуальны (< 2 лет для динамичных тем)
[ ] Нет противоречий между источниками

Граничные случаи:
[ ] Рассмотрены edge-cases
[ ] Указано поведение при ошибках
[ ] Есть fallback-стратегии

Переиспользуемость:
[ ] Результат применим к классу задач
[ ] Нет жёстко закодированных данных
[ ] Документация достаточна для повторения

Минимум для PASS: 18/22 пунктов ✓
```

---

## РАЗДЕЛ 3: АЛГОРИТМЫ САМОПРОВЕРКИ

### 3.1 Алгоритм проверки формата

```
FUNCTION check_format(output, spec):
    
    # Шаг 1: Проверка структуры
    IF spec.format == "markdown":
        CHECK заголовки начинаются с #
        CHECK списки используют - или 1.
        CHECK таблицы имеют | разделители
    
    IF spec.format == "json":
        CHECK JSON.parse(output) не выдаёт ошибку
        CHECK все обязательные поля присутствуют
    
    # Шаг 2: Проверка завершённости
    CHECK последнее предложение завершено точкой
    CHECK нет "[продолжение]" или "..."
    CHECK таблицы имеют все строки
    
    # Шаг 3: Проверка объёма
    CHECK word_count >= spec.min_words
    CHECK word_count <= spec.max_words
    
    RETURN all_checks_passed
```

### 3.2 Алгоритм проверки логики

```
FUNCTION check_logic(output):
    
    # Шаг 1: Извлечение утверждений
    statements = extract_statements(output)
    
    # Шаг 2: Проверка противоречий
    FOR each pair (s1, s2) in statements:
        IF contradicts(s1, s2):
            RETURN FAIL("Противоречие: {s1} vs {s2}")
    
    # Шаг 3: Проверка причинности
    causal_claims = extract_causal_claims(output)
    FOR each claim in causal_claims:
        IF not has_evidence(claim):
            FLAG("Непроверенная причинность: {claim}")
    
    # Шаг 4: Проверка выводов
    conclusions = extract_conclusions(output)
    FOR each conclusion in conclusions:
        IF not follows_from_data(conclusion):
            RETURN FAIL("Вывод не обоснован: {conclusion}")
    
    RETURN PASS
```

### 3.3 Алгоритм проверки полноты

```
FUNCTION check_completeness(output, task):
    
    # Шаг 1: Извлечение требований из задачи
    requirements = extract_requirements(task)
    
    # Шаг 2: Сопоставление с результатом
    covered = []
    FOR each req in requirements:
        IF req IN output:
            covered.append(req)
    
    # Шаг 3: Расчёт покрытия
    coverage = len(covered) / len(requirements) * 100
    
    IF coverage < 100:
        missing = requirements - covered
        RETURN FAIL("Не покрыто: {missing}")
    
    RETURN PASS
```

---

## РАЗДЕЛ 4: ПРОТОКОЛЫ КОРРЕКЦИИ

### 4.1 Протокол исправления ошибок

```
FUNCTION correct_errors(output, errors):
    
    iteration = 1
    MAX_ITERATIONS = 3
    
    WHILE errors AND iteration <= MAX_ITERATIONS:
        
        # Шаг 1: Классификация ошибок
        critical = filter(errors, severity="critical")
        major = filter(errors, severity="major")
        minor = filter(errors, severity="minor")
        
        # Шаг 2: Приоритетное исправление
        IF critical:
            output = fix_critical(output, critical)
        ELIF major:
            output = fix_major(output, major)
        ELSE:
            output = fix_minor(output, minor)
        
        # Шаг 3: Повторная проверка
        errors = self_check(output)
        iteration += 1
    
    IF errors:
        ADD_WARNING("Некоторые ошибки не исправлены после 3 итераций")
    
    RETURN output
```

### 4.2 Типы ошибок и способы исправления

| Тип ошибки | Severity | Способ исправления |
|------------|----------|-------------------|
| Обрезанный артефакт | Critical | Дополнить до завершения |
| Логическое противоречие | Critical | Устранить одно из утверждений |
| Несоответствие формату | Major | Переформатировать |
| Отсутствующая секция | Major | Добавить секцию |
| Повторение информации | Minor | Удалить дубликаты |
| Избыточные пояснения | Minor | Сократить |

---

## РАЗДЕЛ 5: ФОРМАТ БЛОКА САМОПРОВЕРКИ

### 5.1 Структура блока в выходе агента

```markdown
---

## [САМОПРОВЕРКА]

| Проверка | Статус | Комментарий |
|----------|--------|-------------|
| Формат | ✓ | Markdown, все таблицы корректны |
| Полнота | ✓ | Все 5 пунктов задачи покрыты |
| Логика | ✓ | Противоречий не обнаружено |
| [Профильная] | ✓ | [Специфичная проверка] |

**Уровень проверки:** EXTENDED
**Результат:** PASS (14/15)
**Коррекции:** 1 (удалены повторы в разделе 3)

---
```

### 5.2 Минимальный блок (для BASIC уровня)

```markdown
---
## [САМОПРОВЕРКА]
Формат: ✓ | Полнота: ✓ | Соответствие: ✓
Уровень: BASIC | Результат: PASS
---
```

---

## РАЗДЕЛ 6: ИНТЕГРАЦИЯ С ДРУГИМИ ДОКУМЕНТАМИ

### 6.1 Связь с QUALITY_STANDARDS.md

- Метрики из самопроверки используются для расчёта CQS
- Уровень проверки определяет глубину оценки качества
- Результат PASS/FAIL влияет на статус готовности агента

### 6.2 Связь с CONSTRAINTS_REGISTRY.md

- Самопроверка включает проверку соблюдения ограничений
- Нарушение блокирующего ограничения = автоматический FAIL
- Граничные условия проверяются на экспертном уровне

---

## ПРИМЕРЫ ПРИМЕНЕНИЯ

### Пример 1: Базовая самопроверка для К-агента

```
Агент: K-001 (Генератор концепций)
Задача: Сгенерировать 5 названий для приложения

[САМОПРОВЕРКА]

Формат:
[✓] Markdown с заголовками
[✓] Списки корректны
[✓] Нет обрезанных элементов

Полнота:
[✓] 5 названий сгенерировано
[✓] Каждое с описанием и метафорой
[✓] Артефакт завершён

Соответствие:
[✓] Названия для приложения (не для компании)
[✓] Тематика соответствует брифу
[✓] Тон профессиональный

Профиль К:
[✓] ≥ 5 вариантов
[✓] Метафоры присутствуют
[✓] Варианты различаются

Уровень: BASIC | Результат: PASS (12/12)
```

### Пример 2: Экспертная самопроверка с коррекцией

```
Агент: Т-001 (Верификатор фактов)
Задача: Проверить статью о криптовалютах

[САМОПРОВЕРКА — ИТЕРАЦИЯ 1]

Источники:
[✗] Источник 3 датирован 2019 годом (устарел)
[✓] Остальные источники актуальны

Результат: FAIL

[КОРРЕКЦИЯ]
Заменён источник 3 на актуальный (2025)

[САМОПРОВЕРКА — ИТЕРАЦИЯ 2]

Источники:
[✓] Все источники < 2 лет

Результат: PASS

Итоговый статус: PASS после 1 коррекции
```

---

VERSION: 1.0 | DATE: 2026-02-27